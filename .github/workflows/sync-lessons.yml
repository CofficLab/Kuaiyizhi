# ========================================================
# Lessons Sync Workflow
# ========================================================
#
# è¿™ä¸ªå·¥ä½œæµç¨‹ä¼šè‡ªåŠ¨å°† content/lessons ç›®å½•ä¸‹çš„å­ç›®å½•åŒæ­¥åˆ°å¯¹åº”çš„GitHubä»“åº“ã€‚
# åŒæ­¥é‡‡ç”¨"å®Œå…¨è¦†ç›–"ç­–ç•¥ï¼Œè¿œç¨‹ä»“åº“çš„å†…å®¹å°†è¢«å®Œå…¨æ›¿æ¢ä¸ºæœ¬åœ°å†…å®¹ï¼Œå§‹ç»ˆä»¥æœ¬åœ°å†…å®¹ä¸ºå‡†ã€‚
#
# å·¥ä½œæµç¨‹ï¼š
# 1. å½“å‘devåˆ†æ”¯æ¨é€ä»£ç ä¸” content/lessons ç›®å½•æœ‰å˜åŒ–æ—¶è§¦å‘
# 2. æ£€æŸ¥ content/lessons ä¸‹çš„æ‰€æœ‰ä¸€çº§å­ç›®å½•
# 3. å°†æ¯ä¸ªå­ç›®å½•çš„å†…å®¹åŒæ­¥åˆ°ç›¸åº”çš„GitHubä»“åº“ï¼Œè¦†ç›–è¿œç¨‹ä»“åº“å†…å®¹
#    (è¿œç¨‹ä»“åº“å­˜åœ¨ä½†æœ¬åœ°ä¸å­˜åœ¨çš„æ–‡ä»¶å°†è¢«åˆ é™¤)
#
# é…ç½®è¦æ±‚ï¼š
# - éœ€è¦åœ¨ä»“åº“Secretsä¸­é…ç½® SYNC_GITHUB_TOKENï¼Œç”¨äºæœ‰æƒé™è®¿é—®ç›®æ ‡ä»“åº“
#   * Tokenéœ€è¦çš„æƒé™ï¼š
#     - repo (å®Œæ•´çš„ä»“åº“è®¿é—®æƒé™ï¼Œç”¨äºå…‹éš†å’Œæ¨é€å†…å®¹)
#     - workflow (å¦‚æœç›®æ ‡ä»“åº“æœ‰å·¥ä½œæµä¿æŠ¤ï¼Œåˆ™éœ€è¦æ­¤æƒé™)
#     - å¦‚æœç›®æ ‡ä»“åº“åœ¨å¦ä¸€ä¸ªç»„ç»‡ä¸­ï¼ŒTokenéœ€è¦æœ‰è¯¥ç»„ç»‡çš„è®¿é—®æƒé™
#   * åˆ›å»ºæ­¥éª¤ï¼š
#     1. è®¿é—® GitHub > Settings > Developer settings > Personal access tokens
#     2. åˆ›å»ºä¸€ä¸ªå…·æœ‰ä¸Šè¿°æƒé™çš„Fine-grained tokenæˆ–Classic token
#     3. å°†tokenæ·»åŠ åˆ°ä»“åº“çš„Secretsä¸­ï¼Œå‘½åä¸ºSYNC_GITHUB_TOKEN
# - ç›®æ ‡ä»“åº“å¿…é¡»å·²ç»å­˜åœ¨ï¼Œä¸å­˜åœ¨çš„ä»“åº“ä¼šè¢«è‡ªåŠ¨è·³è¿‡å¤„ç†
# - ç›®æ ‡ä»“åº“æ˜ å°„å…³ç³»ï¼š
#   * api_market â†’ BuildMyOwn/api_market
#   * å…¶ä»–å­ç›®å½• â†’ BuildMyOwn/<å­ç›®å½•å> (é»˜è®¤ç»„ç»‡)
# - é»˜è®¤åŒæ­¥åˆ°ç›®æ ‡ä»“åº“çš„ main åˆ†æ”¯
#
# ========================================================

name: Sync Lessons to GitHub Repositories

on:
  push:
    branches:
      - dev
      - main
    paths:
      - 'content/lessons/**'

env:
  DEFAULT_ORG: 'BuildMyOwn' # å¯é…ç½®çš„é»˜è®¤ç»„ç»‡å

jobs:
  sync-lessons:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Git
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"

      - name: Get changed lesson directories
        id: changed-lessons
        run: |
          # ä½¿ç”¨é€—å·åˆ†éš”ç›®å½•åï¼Œä»¥é¿å…æ ¼å¼é—®é¢˜
          lesson_dirs=$(find content/lessons -mindepth 1 -maxdepth 1 -type d -printf "%f," | sed 's/,$//')
          echo "lesson_dirs=$lesson_dirs" >> $GITHUB_OUTPUT

      - name: Sync lessons to repositories
        env:
          GITHUB_TOKEN: ${{ secrets.SYNC_GITHUB_TOKEN }}
          LESSON_DIRS: ${{ steps.changed-lessons.outputs.lesson_dirs }}
        run: |
          # Create a temporary directory for cloning repositories
          mkdir -p /tmp/repos

          # åˆ›å»ºæ•°ç»„ä»¥è®°å½•æˆåŠŸå’Œå¤±è´¥çš„ä»“åº“
          successful_repos=()
          skipped_repos=()

          # ä½¿ç”¨IFSå¤„ç†é€—å·åˆ†éš”çš„ç›®å½•åˆ—è¡¨
          IFS=',' read -ra DIR_ARRAY <<< "$LESSON_DIRS"
          for lesson_dir in "${DIR_ARRAY[@]}"; do
            echo "Processing lesson: $lesson_dir"
            
            # Determine the target repository name based on lesson directory
            if [ "$lesson_dir" = "api_market" ]; then
              # ç‰¹æ®Šä»“åº“æ˜ å°„ï¼Œä½¿ç”¨ç›¸åŒçš„ç»„ç»‡å
              TARGET_REPO="${DEFAULT_ORG}/api_market"
            else
              # é»˜è®¤ä½¿ç”¨é…ç½®çš„ç»„ç»‡å
              TARGET_REPO="${DEFAULT_ORG}/$lesson_dir"
            fi
            
            # Clone the target repository
            echo "Cloning $TARGET_REPO"
            if git clone https://x-access-token:${GITHUB_TOKEN}@github.com/${TARGET_REPO}.git "/tmp/repos/${lesson_dir}" 2>/dev/null; then
              # å…‹éš†æˆåŠŸï¼Œç»§ç»­å¤„ç†
              echo "Successfully cloned $TARGET_REPO"
              
              # Sync the lesson directory to the cloned repository
              echo "Syncing content/lessons/$lesson_dir to repository"
              rsync -av --delete --exclude=".git" "content/lessons/${lesson_dir}/" "/tmp/repos/${lesson_dir}/"
              
              # Commit and push changes
              cd "/tmp/repos/${lesson_dir}"
              
              # Check if there are changes to commit
              if git status --porcelain | grep .; then
                git add .
                git commit -m "Sync lesson content from main repository"
                git push origin main
                echo "Changes pushed to $TARGET_REPO"
                successful_repos+=("$TARGET_REPO (changes pushed)")
              else
                echo "No changes to sync for $TARGET_REPO"
                successful_repos+=("$TARGET_REPO (no changes)")
              fi
              
              cd -
            else
              # å…‹éš†å¤±è´¥ï¼Œä»“åº“å¯èƒ½ä¸å­˜åœ¨
              echo "Warning: Repository $TARGET_REPO not found or not accessible. Skipping this lesson."
              skipped_repos+=("$TARGET_REPO")
            fi
          done

          # è¾“å‡ºæ€»ç»“ä¿¡æ¯
          echo "========================================"
          echo "ğŸ”„ SYNC SUMMARY ğŸ”„"
          echo "========================================"
          echo "ğŸ“Š Total directories processed: ${#DIR_ARRAY[@]}"
          echo "--------------------------------------"

          echo "âœ… Successfully synced repositories (${#successful_repos[@]}):"
          if [ ${#successful_repos[@]} -eq 0 ]; then
            echo "  None"
          else
            for repo in "${successful_repos[@]}"; do
              if [[ $repo == *"(changes pushed)"* ]]; then
                echo "  - ğŸ“ $repo"
              else
                echo "  - ğŸ‘Œ $repo"
              fi
            done
          fi

          echo "--------------------------------------"
          echo "âš ï¸ Skipped repositories (${#skipped_repos[@]}):"
          if [ ${#skipped_repos[@]} -eq 0 ]; then
            echo "  None"
          else
            for repo in "${skipped_repos[@]}"; do
              echo "  - ğŸš« $repo"
            done
          fi
          echo "========================================"

          # æ€»ä½“ç»“æœ
          if [ ${#skipped_repos[@]} -eq 0 ]; then
            echo "ğŸ‰ All repositories were successfully processed!"
          elif [ ${#successful_repos[@]} -eq 0 ]; then
            echo "âŒ No repositories were successfully synced. Please check your configuration."
          else
            echo "âš ï¸ Some repositories were skipped. See details above."
          fi
          echo "========================================"
