---
import LinkDB from '@/database/LinkDB';
import { createAdminClient, SESSION_COOKIE } from '@/server/appwrite';

export const prerender = false;

const { lang = 'en' } = Astro.params;

// 当前链接是这样的格式：xxx?secret=xxx&userId=xxx
const url = Astro.url;
const secret = url.searchParams.get('secret');
const userId = url.searchParams.get('userId');

console.log('secret', secret);
console.log('userId', userId);

if (secret && userId) {
  if (!userId || !secret) {
    throw new Error('OAuth2 did not provide userId or secret');
  }

  const { account } = createAdminClient();

  const session = await account.createSession(userId, secret);
  if (!session || !session.secret) {
    throw new Error('Failed to create session from token');
  }

  Astro.cookies.set(SESSION_COOKIE, session.secret, {
    // sameSite: "strict",
    expires: new Date(session.expire),
    // secure: true,
    httpOnly: true,
    path: '/',
  });

  console.log('redirect to', LinkDB.getAuthAccountLink(lang));

  return Astro.redirect(LinkDB.getAuthAccountLink(lang), 302);
}
---
