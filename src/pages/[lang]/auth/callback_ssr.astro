---
import AppLayout from '@/layouts/AppLayout.astro';
import { createAdminClient, SESSION_COOKIE } from '@/server/appwrite';

export const prerender = false;

const url = Astro.url;
const cookies = Astro.cookies;
const userId = url.searchParams.get('userId');
const secret = url.searchParams.get('secret');

console.log('userId -------------', userId);
console.log('secret -------------', secret);

if (!userId || !secret) {
  throw new Error('OAuth2 did not provide userId or secret');
}

const { account } = createAdminClient();

const session = await account.createSession(userId, secret);
if (!session || !session.secret) {
  throw new Error('Failed to create session from token');
}

console.log('Success');

cookies.set(SESSION_COOKIE, session.secret, {
  // sameSite: "strict",
  expires: new Date(session.expire),
  // secure: true,
  httpOnly: true,
  path: '/',
});
---

<AppLayout title="登录回调" description="这里是SSR OAuth登录的回调页面">
  <h2>callback</h2>
</AppLayout>
