---
import AuthCallback from '@/components/AuthCallback.vue';
import AppLayout from '@/layouts/AppLayout.astro';
import { createAdminClient, SESSION_COOKIE } from '@/server/appwrite';

export const prerender = false;

const { lang = 'en' } = Astro.params;
const title = lang === 'zh-cn' ? '登录验证' : 'Sign in Verification';
const description = lang === 'zh-cn' ? '登录验证' : 'Sign in verification';

// 当前链接是这样的格式：xxx?secret=xxx&userId=xxx
const url = Astro.url;
const secret = url.searchParams.get('secret');
const userId = url.searchParams.get('userId');

console.log('secret', secret);
console.log('userId', userId);

if (secret && userId) {
  if (!userId || !secret) {
    throw new Error('OAuth2 did not provide userId or secret');
  }

  const { account } = createAdminClient();

  const session = await account.createSession(userId, secret);
  if (!session || !session.secret) {
    throw new Error('Failed to create session from token');
  }

  Astro.cookies.set(SESSION_COOKIE, session.secret, {
    // sameSite: "strict",
    expires: new Date(session.expire),
    // secure: true,
    httpOnly: true,
    path: '/',
  });

  return Astro.redirect('/zh-cn/auth/account');
}
---

<AppLayout title={title} description={description}>
  <AuthCallback lang={lang} client:load />
</AppLayout>
