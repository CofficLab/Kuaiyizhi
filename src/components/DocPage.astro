---
import DocLayout from '@layouts/DocLayout.astro';
import {
  getDocBySlug,
  getParentDocSlug,
  getTopCategory,
} from '@database/content_db';
import { render } from 'astro:content';
import {
  getSidebarItemByDocId,
  getSidebarItemBySlug,
  getSidebarItemsByDocId,
} from '@/database/sidebar_db';
import { slugToId } from '@database/content_db';

export interface Props {
  slug: string;
  redirectPath: string;
}

const { slug, redirectPath } = Astro.props;

const debug = true;

if (debug) {
  console.log('ðŸ“‘ DocPage: slug', slug);
}

const doc = await getDocBySlug(slug);

if (!doc) {
  return Astro.redirect(redirectPath, 307);
}

const { Content, headings } = await render(doc);

const topCategory = getTopCategory(slug);

let sidebarItem;
if (topCategory === 'meta') {
  sidebarItem = await getSidebarItemBySlug(getParentDocSlug(slug), 1);
} else {
  sidebarItem = await getSidebarItemByDocId(slugToId(slug), 1);
}

if (debug) {
  console.log('ðŸ“‘ DocPage: sidebarItem', sidebarItem);
}
---

<DocLayout
  title={doc.data.title as string}
  description={doc.data.description as string}
  sidebarItem={sidebarItem}
  headings={headings}>
  <Content />
</DocLayout>
